<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.34">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Fastai Transforms API to Severstal dataset.">

<title>Transforms – steel_segmentation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-c8ad9e5dbd60b7b70b38521ab19b7da4.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ac0578e1f87f273c3fa40b04908a6ea7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Transforms – steel_segmentation">
<meta property="og:description" content="Fastai Transforms API to Severstal dataset.">
<meta property="og:image" content="https://marcomatteo.github.io/steel_segmentation/02_transforms_files/figure-html/cell-15-output-1.svg">
<meta property="og:site_name" content="steel_segmentation">
<meta name="twitter:title" content="Transforms – steel_segmentation">
<meta name="twitter:description" content="Fastai Transforms API to Severstal dataset.">
<meta name="twitter:image" content="https://marcomatteo.github.io/steel_segmentation/02_transforms_files/figure-html/cell-15-output-1.svg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">steel_segmentation</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Transforms</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-data-pipeline-steelmask-block" id="toc-the-data-pipeline-steelmask-block" class="nav-link active" data-scroll-target="#the-data-pipeline-steelmask-block">The Data pipeline: SteelMask Block</a>
  <ul class="collapse">
  <li><a href="#get_x-transform" id="toc-get_x-transform" class="nav-link" data-scroll-target="#get_x-transform">Get_x transform</a></li>
  <li><a href="#readimagepathfromindex" id="toc-readimagepathfromindex" class="nav-link" data-scroll-target="#readimagepathfromindex">ReadImagePathFromIndex</a></li>
  <li><a href="#get_y-transform" id="toc-get_y-transform" class="nav-link" data-scroll-target="#get_y-transform">Get_y transform</a></li>
  <li><a href="#readrles" id="toc-readrles" class="nav-link" data-scroll-target="#readrles">ReadRLEs</a></li>
  <li><a href="#get-mask-from-rles" id="toc-get-mask-from-rles" class="nav-link" data-scroll-target="#get-mask-from-rles">Get Mask from RLEs</a></li>
  <li><a href="#makemask" id="toc-makemask" class="nav-link" data-scroll-target="#makemask">MakeMask</a></li>
  <li><a href="#channel-mask" id="toc-channel-mask" class="nav-link" data-scroll-target="#channel-mask">4-channel Mask</a></li>
  <li><a href="#channelmask" id="toc-channelmask" class="nav-link" data-scroll-target="#channelmask">ChannelMask</a></li>
  <li><a href="#albumentation-transforms" id="toc-albumentation-transforms" class="nav-link" data-scroll-target="#albumentation-transforms">Albumentation transforms</a></li>
  <li><a href="#albumentationstransform" id="toc-albumentationstransform" class="nav-link" data-scroll-target="#albumentationstransform">AlbumentationsTransform</a></li>
  <li><a href="#get_valid_aug" id="toc-get_valid_aug" class="nav-link" data-scroll-target="#get_valid_aug">get_valid_aug</a></li>
  <li><a href="#get_train_aug" id="toc-get_train_aug" class="nav-link" data-scroll-target="#get_train_aug">get_train_aug</a></li>
  <li><a href="#steelmaskblock" id="toc-steelmaskblock" class="nav-link" data-scroll-target="#steelmaskblock">SteelMaskBlock</a></li>
  <li><a href="#steelmaskblock-1" id="toc-steelmaskblock-1" class="nav-link" data-scroll-target="#steelmaskblock-1">SteelMaskBlock</a></li>
  </ul></li>
  <li><a href="#steeldatablock" id="toc-steeldatablock" class="nav-link" data-scroll-target="#steeldatablock">SteelDatablock</a>
  <ul class="collapse">
  <li><a href="#steeldatablock-1" id="toc-steeldatablock-1" class="nav-link" data-scroll-target="#steeldatablock-1">SteelDataBlock</a></li>
  </ul></li>
  <li><a href="#k-folds-strategy" id="toc-k-folds-strategy" class="nav-link" data-scroll-target="#k-folds-strategy">K-Folds strategy</a>
  <ul class="collapse">
  <li><a href="#get_kfold_splits" id="toc-get_kfold_splits" class="nav-link" data-scroll-target="#get_kfold_splits">get_kfold_splits</a></li>
  <li><a href="#kfoldsplitter" id="toc-kfoldsplitter" class="nav-link" data-scroll-target="#kfoldsplitter">KFoldSplitter</a></li>
  </ul></li>
  <li><a href="#steeldataloaders" id="toc-steeldataloaders" class="nav-link" data-scroll-target="#steeldataloaders">SteelDataLoaders</a>
  <ul class="collapse">
  <li><a href="#steeldataloaders-1" id="toc-steeldataloaders-1" class="nav-link" data-scroll-target="#steeldataloaders-1">SteelDataLoaders</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="transforms.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Transforms</h1>
</div>

<div>
  <div class="description">
    Fastai Transforms API to Severstal dataset.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>The <code>fastai</code> data block API cannot give us a tuple (<code>input</code>,<code>target</code>) data for our Deep Learning model. That’s why we need to create custom <code>Transform</code>s to fix this problem and leverage anyway the high level framework.</p>
<div id="cell-6" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">"../data"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> path.is_dir()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-7" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>train_pivot <span class="op">=</span> get_train_df(path, only_faulty<span class="op">=</span><span class="va">True</span>, pivot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train pivot shape: "</span>, train_pivot.shape)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>train_pivot.head(n<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train pivot shape:  (6666, 6)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ClassId</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">n</th>
<th data-quarto-table-cell-role="th">ClassIds</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ImageId</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0002cc93b.jpg</td>
<td>29102 12 29346 24 29602 24 29858 24 30114 24 30370 24 30626 24 30882 24 31139 23 31395 23 31651 23 31907 23 32163 23 32419 23 32675 23 77918 27 78174 55 78429 60 78685 64 78941 68 79197 72 79452 77 79708 81 79964 85 80220 89 80475 94 80731 98 80987 102 81242 105 81498 105 81754 104 82010 104 82265 105 82521 31 82556 69 82779 27 82818 63 83038 22 83080 57 83297 17 83342 50 83555 13 83604 44 83814 8 83866 37 84073 3 84128 31 84390 25 84652 18 84918 8 85239 10 85476 29 85714 47 85960 57 86216 57 86471 58 86727 58 86983 58 87238 59 87494 59 87750 59 88005 60 88261 60 88517 60 88772 61 89028 53...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0007a71bf.jpg</td>
<td>NaN</td>
<td>NaN</td>
<td>18661 28 18863 82 19091 110 19347 110 19603 110 19859 110 20115 110 20371 110 20627 110 20883 110 21139 110 21395 110 21651 110 21962 55 293125 251 293381 251 293637 251 293893 251 294149 251 294405 251 294661 251 294917 251 295173 251 295429 251 295685 251 295941 251 296197 251 296453 251 296709 251 296965 251 297221 251 297477 251 297733 251 297989 251 298245 251 298564 188 298945 63</td>
<td>NaN</td>
<td>1</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">000a4bcdd.jpg</td>
<td>37607 3 37858 8 38108 14 38359 20 38610 25 38863 28 39119 28 39375 29 39631 29 39887 29 40143 29 40399 29 40655 30 40911 30 41167 30 41423 30 41679 31 41935 31 42191 31 42447 31 42703 31 42960 31 43216 31 43472 31 43728 31 43984 31 44240 32 44496 32 44752 32 45008 32 45264 33 45520 33 45776 33 46032 33 46288 33 46544 34 46803 31 47065 25 47327 19 47588 15 47850 9 48112 3 62667 12 62923 23 63179 23 63348 3 63435 23 63604 7 63691 23 63860 11 63947 23 64116 15 64203 23 64372 19 64459 23 64628 24 64715 23 64884 28 64971 23 65139 33 65227 23 65395 37 65483 23 65651 41 65740 22 65907 45 65996 22...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>train_example <span class="op">=</span> train_pivot.sample().iloc[<span class="dv">0</span>]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>train_example.name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>'fdab86eb7.jpg'</code></pre>
</div>
</div>
<section id="the-data-pipeline-steelmask-block" class="level2">
<h2 class="anchored" data-anchor-id="the-data-pipeline-steelmask-block">The Data pipeline: SteelMask Block</h2>
<section id="get_x-transform" class="level3">
<h3 class="anchored" data-anchor-id="get_x-transform">Get_x transform</h3>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L19" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="readimagepathfromindex" class="level3">
<h3 class="anchored" data-anchor-id="readimagepathfromindex">ReadImagePathFromIndex</h3>
<blockquote class="blockquote">
<pre><code> ReadImagePathFromIndex (pref)</code></pre>
</blockquote>
<p><em>Read image name from <code>train_pivot</code> and returns the image path</em></p>
<p>With the <a href="https://marcomatteo.github.io/steel_segmentation/transforms.html#readimagepathfromindex"><code>ReadImagePathFromIndex</code></a> transform we can get the first information of the training example, the image path for <code>train_example</code> from <code>train_pivot</code>. In setup we need to specify the prefix to be added to the <code>ImageId</code> of the training image.</p>
<div id="cell-13" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>x_tfm <span class="op">=</span> ReadImagePathFromIndex(pref<span class="op">=</span>(path<span class="op">/</span><span class="st">"train_images"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> x_tfm(train_example)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>test_eq(x, <span class="bu">str</span>(path<span class="op">/</span><span class="st">"train_images"</span><span class="op">/</span>train_example.name))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get_y-transform" class="level3">
<h3 class="anchored" data-anchor-id="get_y-transform">Get_y transform</h3>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L29" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="readrles" class="level3">
<h3 class="anchored" data-anchor-id="readrles">ReadRLEs</h3>
<blockquote class="blockquote">
<pre><code> ReadRLEs (cols=[1, 2, 3, 4])</code></pre>
</blockquote>
<p><em>Read RLEs from <code>train_pivot</code> and return a list or RLEs.</em></p>
<p>With the <a href="https://marcomatteo.github.io/steel_segmentation/transforms.html#readrles"><code>ReadRLEs</code></a> transform we can get our labels, the list of RLEs (one for each <code>ClassId</code>s). In the setup we need to specify the column names of the <code>ClassId</code>. In input we pass the <code>train_example</code> and we get a list of strings as output.</p>
<div id="cell-18" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>y_tfm <span class="op">=</span> ReadRLEs(cols<span class="op">=</span>cols)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>rles <span class="op">=</span> y_tfm(train_example)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="bu">len</span>(rles), <span class="dv">4</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>test_eq(rles, [train_example[i] <span class="cf">if</span> <span class="kw">not</span> train_example[i] <span class="kw">is</span> np.nan <span class="cf">else</span> <span class="st">''</span> <span class="cf">for</span> i <span class="kw">in</span> cols])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-mask-from-rles" class="level3">
<h3 class="anchored" data-anchor-id="get-mask-from-rles">Get Mask from RLEs</h3>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L39" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="makemask" class="level3">
<h3 class="anchored" data-anchor-id="makemask">MakeMask</h3>
<blockquote class="blockquote">
<pre><code> MakeMask (flatten=True)</code></pre>
</blockquote>
<p><em>Read RLEs list and return a np.array of the mask</em></p>
<p>The <a href="https://marcomatteo.github.io/steel_segmentation/transforms.html#makemask"><code>MakeMask</code></a> transform needs a list of RLEs and returns a mask with <code>(256, 1600)</code> shape if <code>flatten</code> is <code>True</code> (default). If <code>flatten</code> is <code>False</code> returns a <code>(256, 1600, 4)</code> array.</p>
<div id="cell-22" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mask_tfm <span class="op">=</span> MakeMask(flatten<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> mask_tfm(rles)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>test_eq(mask.shape, (<span class="dv">256</span>,<span class="dv">1600</span>,<span class="dv">4</span>))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Default transform with flatten mask for PILMask.create</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>flatten_mask_tfm <span class="op">=</span> MakeMask()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>flatten_mask <span class="op">=</span> flatten_mask_tfm(rles)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>test_eq(flatten_mask.shape, (<span class="dv">256</span>,<span class="dv">1600</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-23" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">5</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>plt.xticks([])</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>plt.yticks([])</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>plt.imshow(flatten_mask)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-15-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-24" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>rle <span class="op">=</span> mask_tfm.decode(mask)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>test_eq(rle, rles)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>flatten_rle <span class="op">=</span> flatten_mask_tfm.decode(flatten_mask)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>test_eq(flatten_rle, rles)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, a <code>Datasets</code> object can be built from the two <code>Pipeline</code>s created with the previous transforms.</p>
<div id="cell-26" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>x_tfms <span class="op">=</span> Pipeline([x_tfm, PILImage.create])</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>y_tfms <span class="op">=</span> Pipeline([y_tfm, flatten_mask_tfm, PILMask.create])</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(train_pivot, [x_tfms, y_tfms])</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>elem <span class="op">=</span> dsets.train[<span class="dv">1</span>]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>image, mask <span class="op">=</span> elem</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(elem), image, mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(tuple, PILImage mode=RGB size=1600x256, PILMask mode=F size=1600x256)</code></pre>
</div>
</div>
<div id="cell-27" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>_,axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">5</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>image.show(ctx<span class="op">=</span>axs[<span class="dv">0</span>], title<span class="op">=</span><span class="st">'image'</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>mask.show(alpha<span class="op">=</span><span class="dv">1</span>, ctx<span class="op">=</span>axs[<span class="dv">1</span>], vmin<span class="op">=</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">30</span>, title<span class="op">=</span><span class="st">'mask'</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>image.show(ctx<span class="op">=</span>axs[<span class="dv">2</span>], title<span class="op">=</span><span class="st">'superimposed'</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>mask.show(ctx<span class="op">=</span>axs[<span class="dv">2</span>], vmin<span class="op">=</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">30</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-18-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="channel-mask" class="level3">
<h3 class="anchored" data-anchor-id="channel-mask">4-channel Mask</h3>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L65" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="channelmask" class="level3">
<h3 class="anchored" data-anchor-id="channelmask">ChannelMask</h3>
<blockquote class="blockquote">
<pre><code> ChannelMask (enc=None, dec=None, split_idx=None, order=None)</code></pre>
</blockquote>
<p><em>Transform (x,y) tensor masks from [w, h] to [channels, w, h]</em></p>
<p>The <a href="https://marcomatteo.github.io/steel_segmentation/transforms.html#channelmask"><code>ChannelMask</code></a> transform changes the shape of the mask from a flatten <code>(256, 1600)</code> to <code>(4, 256, 1600)</code>.</p>
<div id="cell-31" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>tens <span class="op">=</span> ToTensor()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>timg, tmask <span class="op">=</span> tens(elem)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>timg.shape, tmask.shape, tmask.dim()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(torch.Size([3, 256, 1600]), torch.Size([256, 1600]), 2)</code></pre>
</div>
</div>
<div id="cell-32" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> ChannelMask()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>ch_mask <span class="op">=</span> tfm(tmask)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>ch_mask.shape, ch_mask.dim()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>(torch.Size([4, 256, 1600]), 3)</code></pre>
</div>
</div>
<div id="cell-33" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>decoded_mask <span class="op">=</span> tfm.decodes(ch_mask)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>decoded_mask.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>torch.Size([256, 1600])</code></pre>
</div>
</div>
<div id="cell-34" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>test_close(decoded_mask, tmask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>show_images((decoded_mask,tmask), figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-24-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It works with batches:</p>
<div id="cell-37" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>bs_tmask <span class="op">=</span> tmask.unsqueeze(<span class="dv">0</span>).expand(<span class="dv">6</span>, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> ChannelMask()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>bs_ch_mask <span class="op">=</span> tfm(bs_tmask)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>bs_ch_mask.shape, bs_ch_mask.dim()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>(torch.Size([6, 4, 256, 1600]), 4)</code></pre>
</div>
</div>
<div id="cell-38" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>decoded_bs_mask <span class="op">=</span> tfm.decodes(bs_ch_mask)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>decoded_bs_mask.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>torch.Size([6, 256, 1600])</code></pre>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ch, tmp_mask <span class="kw">in</span> <span class="bu">enumerate</span>(bs_ch_mask):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    test_close(decoded_bs_mask[ch, ...], bs_tmask[ch, ...])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="albumentation-transforms" class="level3">
<h3 class="anchored" data-anchor-id="albumentation-transforms">Albumentation transforms</h3>
<div id="cell-41" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>img, mask <span class="op">=</span> elem</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>img, mask <span class="op">=</span> np.array(img), np.array(mask)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>img.shape, mask.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>((256, 1600, 3), (256, 1600))</code></pre>
</div>
</div>
<p>Some augmentations from the <code>albumentation</code> library:</p>
<div id="cell-43" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_aug(aug, img, mask):</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    aug_elem <span class="op">=</span> aug(image<span class="op">=</span>img, mask<span class="op">=</span>mask)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    aug_crop_img <span class="op">=</span> aug_elem[<span class="st">"image"</span>]</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    aug_crop_mask <span class="op">=</span> aug_elem[<span class="st">"mask"</span>]</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(aug_crop_img.shape, aug_crop_mask.shape)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique elems in mask: </span><span class="sc">{</span>np<span class="sc">.</span>unique(aug_crop_mask)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    show_images((aug_crop_img, aug_crop_mask), figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">20</span>))</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> aug_crop_img, aug_crop_mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-44" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>aug <span class="op">=</span> alb.CropNonEmptyMaskIfExists(<span class="dv">256</span>, <span class="dv">400</span>, p<span class="op">=</span><span class="fl">1.</span>, ignore_values<span class="op">=</span>[<span class="dv">0</span>])</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>aug_crop_img, aug_crop_mask <span class="op">=</span> show_aug(aug, img, mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(256, 400, 3) (256, 400)
Unique elems in mask: [0. 3.]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-30-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-45" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>aug <span class="op">=</span> alb.VerticalFlip(p<span class="op">=</span><span class="fl">1.</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>aug_img, aug_mask <span class="op">=</span> show_aug(aug, aug_crop_img, aug_crop_mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(256, 400, 3) (256, 400)
Unique elems in mask: [0. 3.]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-31-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-46" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>aug <span class="op">=</span> alb.HorizontalFlip(p<span class="op">=</span><span class="fl">1.</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>aug_img, aug_mask <span class="op">=</span> show_aug(aug, aug_crop_img, aug_crop_mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(256, 400, 3) (256, 400)
Unique elems in mask: [0. 3.]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-32-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-47" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>aug <span class="op">=</span> alb.ElasticTransform(p<span class="op">=</span><span class="fl">1.</span>, alpha<span class="op">=</span><span class="dv">120</span>, sigma<span class="op">=</span><span class="dv">120</span> <span class="op">*</span> <span class="fl">0.05</span>, alpha_affine<span class="op">=</span><span class="dv">120</span> <span class="op">*</span> <span class="fl">0.03</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>aug_img, aug_mask <span class="op">=</span> show_aug(aug, aug_crop_img, aug_crop_mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(256, 400, 3) (256, 400)
Unique elems in mask: [0. 3.]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-33-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-48" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>aug <span class="op">=</span> alb.GridDistortion(p<span class="op">=</span><span class="fl">1.</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>aug_img, aug_mask <span class="op">=</span> show_aug(aug, aug_crop_img, aug_crop_mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(256, 400, 3) (256, 400)
Unique elems in mask: [0. 3.]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-34-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-49" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>aug <span class="op">=</span> alb.OpticalDistortion(distort_limit<span class="op">=</span><span class="fl">0.5</span>, shift_limit<span class="op">=</span><span class="fl">0.05</span>, p<span class="op">=</span><span class="fl">1.</span>, border_mode<span class="op">=</span>cv2.BORDER_REPLICATE)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>aug_img, aug_mask <span class="op">=</span> show_aug(aug, aug_crop_img, aug_crop_mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(256, 400, 3) (256, 400)
Unique elems in mask: [0. 3.]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-35-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>All is wrapped up in <a href="https://marcomatteo.github.io/steel_segmentation/transforms.html#get_train_aug"><code>get_train_aug</code></a> and <a href="https://marcomatteo.github.io/steel_segmentation/transforms.html#get_valid_aug"><code>get_valid_aug</code></a> for training and validation augmentations. Then <code>AlbumentationTransform</code> is a mixed Transform for the DataBlock.</p>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L126" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="albumentationstransform" class="level3">
<h3 class="anchored" data-anchor-id="albumentationstransform">AlbumentationsTransform</h3>
<blockquote class="blockquote">
<pre><code> AlbumentationsTransform (train_aug, valid_aug)</code></pre>
</blockquote>
<p><em>A transform handler for multiple <code>Albumentation</code> transforms</em></p>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L122" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_valid_aug" class="level3">
<h3 class="anchored" data-anchor-id="get_valid_aug">get_valid_aug</h3>
<blockquote class="blockquote">
<pre><code> get_valid_aug (height, width)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L104" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_train_aug" class="level3">
<h3 class="anchored" data-anchor-id="get_train_aug">get_train_aug</h3>
<blockquote class="blockquote">
<pre><code> get_train_aug (height, width)</code></pre>
</blockquote>
<div id="cell-54" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>train_aug <span class="op">=</span> get_train_aug(<span class="dv">256</span>, <span class="dv">400</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>aug_img, aug_mask <span class="op">=</span> show_aug(train_aug, aug_crop_img, aug_crop_mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(256, 400, 3) (256, 400)
Unique elems in mask: [0. 3.]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-39-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-55" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>valid_aug <span class="op">=</span> get_valid_aug(<span class="dv">256</span>, <span class="dv">400</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>aug_img, aug_mask <span class="op">=</span> show_aug(valid_aug, aug_crop_img, aug_crop_mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(256, 400, 3) (256, 400)
Unique elems in mask: [0. 3.]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-40-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-56" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>alb_tfm <span class="op">=</span> AlbumentationsTransform(train_aug, valid_aug)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>alb_aug_elem <span class="op">=</span> alb_tfm(elem, split_idx<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>show_images(alb_aug_elem, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_transforms_files/figure-html/cell-41-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="steelmaskblock" class="level3">
<h3 class="anchored" data-anchor-id="steelmaskblock">SteelMaskBlock</h3>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L148" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="steelmaskblock-1" class="level3">
<h3 class="anchored" data-anchor-id="steelmaskblock-1">SteelMaskBlock</h3>
<blockquote class="blockquote">
<pre><code> SteelMaskBlock (train_aug, valid_aug)</code></pre>
</blockquote>
</section>
</section>
<section id="steeldatablock" class="level2">
<h2 class="anchored" data-anchor-id="steeldatablock">SteelDatablock</h2>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L169" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="steeldatablock-1" class="level3">
<h3 class="anchored" data-anchor-id="steeldatablock-1">SteelDataBlock</h3>
<blockquote class="blockquote">
<pre><code> SteelDataBlock (path, splitter=None, train_aug=None, valid_aug=None,
                 *args, **kwargs)</code></pre>
</blockquote>
<p><em>Get the DataBlock for Severstal Dataset.</em></p>
<div id="cell-61" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>splitter <span class="op">=</span> TrainTestSplitter(<span class="fl">0.15</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>block <span class="op">=</span> SteelDataBlock(path, splitter)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> block.dataloaders(</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    source<span class="op">=</span>train_pivot, </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    bs<span class="op">=</span><span class="dv">16</span>, </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    num_workers<span class="op">=</span><span class="dv">0</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> dls.one_batch()</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>xb.shape, yb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\beanTech\miniconda3\envs\steel_segmentation\lib\site-packages\torch\_tensor.py:575: UserWarning: floor_divide is deprecated, and will be removed in a future version of pytorch. It currently rounds toward 0 (like the 'trunc' function NOT 'floor'). This results in incorrect rounding for negative values.
To keep the current behavior, use torch.div(a, b, rounding_mode='trunc'), or for actual floor division, use torch.div(a, b, rounding_mode='floor'). (Triggered internally at  ..\aten\src\ATen\native\BinaryOps.cpp:467.)
  return torch.floor_divide(self, other)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>(torch.Size([16, 3, 224, 1568]), torch.Size([16, 4, 224, 1568]))</code></pre>
</div>
</div>
</section>
</section>
<section id="k-folds-strategy" class="level2">
<h2 class="anchored" data-anchor-id="k-folds-strategy">K-Folds strategy</h2>
<p>The scikit-learn <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.StratifiedKFold.html#sklearn.model_selection.StratifiedKFold">StratifiedKFold</a> class for this dataset.</p>
<div id="cell-64" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>nsplits <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># df = train_pivot[[1,2,3,4]].stack().to_frame().reset_index()</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> train_pivot.reset_index()</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df[<span class="st">"ImageId"</span>].to_numpy()</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df[<span class="st">"ClassIds"</span>].to_numpy()</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>X.shape, y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>((6578,), (6578,))</code></pre>
</div>
</div>
<div id="cell-65" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>skf <span class="op">=</span> StratifiedKFold(n_splits<span class="op">=</span>nsplits, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> {i: _ <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(nsplits)}</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (train_index, valid_index) <span class="kw">in</span> <span class="bu">enumerate</span>(skf.split(X, y)):</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">-fold:"</span>,</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Train: #</span><span class="sc">{</span><span class="bu">len</span>(train_index)<span class="sc">}</span><span class="ss">, e.g. </span><span class="sc">{</span>train_index[:<span class="dv">5</span>]<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Valid: #</span><span class="sc">{</span><span class="bu">len</span>(valid_index)<span class="sc">}</span><span class="ss">, e.g. </span><span class="sc">{</span>valid_index[:<span class="dv">5</span>]<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>        sep<span class="op">=</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>, end<span class="op">=</span><span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0-fold:
Train: #3289, e.g. [ 1  6 12 13 15]
Valid: #3289, e.g. [0 2 3 4 5]

1-fold:
Train: #3289, e.g. [0 2 3 4 5]
Valid: #3289, e.g. [ 1  6 12 13 15]
</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L189" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="get_kfold_splits" class="level3">
<h3 class="anchored" data-anchor-id="get_kfold_splits">get_kfold_splits</h3>
<blockquote class="blockquote">
<pre><code> get_kfold_splits (df_pivot, nsplits=2)</code></pre>
</blockquote>
<div id="cell-67" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> get_kfold_splits(train_pivot, nsplits<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0-fold:
Train: #3289, e.g. [ 0  2  5  6 12]
Valid: #3289, e.g. [1 3 4 7 8]

1-fold:
Train: #3289, e.g. [1 3 4 7 8]
Valid: #3289, e.g. [ 0  2  5  6 12]
</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L206" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kfoldsplitter" class="level3">
<h3 class="anchored" data-anchor-id="kfoldsplitter">KFoldSplitter</h3>
<blockquote class="blockquote">
<pre><code> KFoldSplitter (splits, idx)</code></pre>
</blockquote>
<div id="cell-69" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>splits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>[[(#3289) [0,2,5,6,12,17,18,19,23,26...],
  (#3289) [1,3,4,7,8,9,10,11,13,14...]],
 [(#3289) [1,3,4,7,8,9,10,11,13,14...],
  (#3289) [0,2,5,6,12,17,18,19,23,26...]]]</code></pre>
</div>
</div>
</section>
</section>
<section id="steeldataloaders" class="level2">
<h2 class="anchored" data-anchor-id="steeldataloaders">SteelDataLoaders</h2>
<hr>
<p><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/blob/master/steel_segmentation/transforms.py#L214" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="steeldataloaders-1" class="level3">
<h3 class="anchored" data-anchor-id="steeldataloaders-1">SteelDataLoaders</h3>
<blockquote class="blockquote">
<pre><code> SteelDataLoaders (block, source, bs, *args, **kwargs)</code></pre>
</blockquote>
<p><em>Get the DataLoaders for Severstal Dataset.</em></p>
<div id="cell-72" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> SteelDataLoaders(block, train_pivot, bs<span class="op">=</span><span class="dv">16</span>, size<span class="op">=</span>(<span class="dv">256</span>, <span class="dv">400</span>))</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> dls.one_batch()</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>xb.shape, yb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>(torch.Size([16, 3, 224, 1568]), torch.Size([16, 4, 224, 1568]))</code></pre>
</div>
</div>
<div id="cell-73" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, split <span class="kw">in</span> <span class="bu">enumerate</span>(splits):</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    block <span class="op">=</span> SteelDataBlock(path, splitter<span class="op">=</span>KFoldSplitter(splits, idx))</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    dls <span class="op">=</span> SteelDataLoaders(block, train_pivot, bs<span class="op">=</span><span class="dv">16</span>, size<span class="op">=</span>(<span class="dv">256</span>, <span class="dv">400</span>))</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> - Train items:</span><span class="ch">\n</span><span class="sc">{</span>dls<span class="sc">.</span>train<span class="sc">.</span>items<span class="sc">.</span>ClassIds<span class="sc">.</span>value_counts()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> - Valid items:</span><span class="ch">\n</span><span class="sc">{</span>dls<span class="sc">.</span>valid<span class="sc">.</span>items<span class="sc">.</span>ClassIds<span class="sc">.</span>value_counts()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 - Train items:
3        2346
1         381
4         254
3 4       140
2          97
1 3        45
1 2        18
2 3         7
1 2 3       1
Name: ClassIds, dtype: int64
1 - Valid items:
3        2345
1         382
4         254
3 4       141
2          97
1 3        45
1 2        17
2 3         7
1 2 3       1
Name: ClassIds, dtype: int64
1 - Train items:
3        2345
1         382
4         254
3 4       141
2          97
1 3        45
1 2        17
2 3         7
1 2 3       1
Name: ClassIds, dtype: int64
1 - Valid items:
3        2346
1         381
4         254
3 4       140
2          97
1 3        45
1 2        18
2 3         7
1 2 3       1
Name: ClassIds, dtype: int64</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/marcomatteo\.github\.io\/steel_segmentation\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>